name: Full Stack Deploy (EKS + NGINX + S3)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
      AWS_ECR_URL: ${{ secrets.AWS_ECR_URL }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to ECR
      uses: aws-actions/amazon-ecr-login@v2

    # ----------------------------------------
    # Backend Build & Push to ECR
    # ----------------------------------------

    - name: Build and push backend image
      working-directory: ./0.0.1/backend
      run: |
        docker build -t backend .
        docker tag backend:latest $AWS_ECR_URL:latest
        docker push $AWS_ECR_URL:latest

    # ----------------------------------------
    # kubectl (Connect to EKS)
    # ----------------------------------------

    - name: Install kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: v1.30.0

    - name: Configure kubeconfig
      run: |
        aws eks update-kubeconfig \
          --name $EKS_CLUSTER_NAME \
          --region $AWS_REGION

    # ----------------------------------------
    # Deploy Backend (ORDERED)
    # ----------------------------------------
    - name: Deploy backend manifests
      run: |
        kubectl apply -f infra/K8s/namespace.yaml
        kubectl apply -f infra/K8s/db.yaml
        kubectl apply -f infra/K8s/deployment.yaml
        kubectl apply -f infra/K8s/service.yaml
        kubectl apply -f infra/K8s/ingress.yaml

    # ----------------------------------------
    # Resolve API_BASE via NGINX
    # ----------------------------------------

    - name: Get NGINX ingress external address
      run: |
        echo "Waiting for NGINX ingress LoadBalancer..."
        for i in {1..30}; do
          HOST=$(kubectl get svc ingress-nginx-controller \
            -n ingress-nginx \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

          if [ -n "$HOST" ]; then
            echo "API_BASE=https://$HOST" >> $GITHUB_ENV
            echo "Resolved API_BASE=https://$HOST"
            exit 0
          fi

          sleep 10
        done

        echo "NGINX ingress not ready" >&2
        exit 1
    
    # ----------------------------------------
    # Frontend
    # ----------------------------------------
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: Install frontend deps
      working-directory: ./0.0.1/frontend/poc_frontend
      run: npm ci

    - name: Build frontend with API_BASE
      working-directory: ./0.0.1/frontend/poc_frontend
      env:
        VITE_API_BASE: ${{ env.API_BASE }}
      run: npm run build

    - name: Sync frontend to S3
      working-directory: ./0.0.1/frontend/poc_frontend
      run: aws s3 sync dist s3://${{ secrets.S3_BUCKET }} --delete